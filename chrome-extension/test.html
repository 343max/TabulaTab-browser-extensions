<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>Tabulatabs js client test</title>
		<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.2.0.css" >
		<script src="js/base64.js"></script>
		<script src="js/gibberish-aes.js"></script>
		<script src="js/jquery-1.7.1.min.js"></script>
		<script src="js/webtoolkit.sha1.js"></script>
		<script src="js/findMetaInPageTitle.js"></script>
		<script src="js/tabulatabs-client.js"></script>
		<script src="js/tabulatabs-encryption.js"></script>
		<script src="js/tabulatabs-browser.js"></script>
		<script src="js/qunit-1.2.0.js"></script>
	</head>
	<body>


  <h1 id="qunit-header">Tabulatabs JS Client</h1>
  <h2 id="qunit-banner"></h2>
  <ol id="qunit-tests"></ol>
<script>
test("cross domain connection, server responding", function() {
	stop(3);

	$.get(tabulatabsServerPath + 'hello/hello.json', function(r) {
		equal(r.greeted, 'Hello World!', 'get response test to json controller');
		start();
	});

	$.ajax(tabulatabsServerPath + 'hello/hello_secure.json', {
		type: 'GET',
		username: 'Tester',
		password: 'greets',
		beforeSend: function(jqXHR, settings) {
			if (settings.username) {
				jqXHR.setRequestHeader('Authorization', 'Basic ' + base64_encode(settings.username + ':' + settings.password) + '==');
			}
		},
		success: function(r) {
			equal(r.greeted, 'Hello Tester!', 'authentification is working');
			start();
		}
	});

	var xhr = new XMLHttpRequest();
	xhr.open('get', tabulatabsServerPath + 'hello/hello_secure.json');
	xhr.setRequestHeader('Authorization', 'Basic ' + base64_encode('Tester' + ':' + 'greets') + '==');
	xhr.onreadystatechange = function(e){
		if(xhr.readyState != 4)
			return;

		var o = JSON.parse(xhr.responseText);
		equal(o.greeted, 'Hello Tester!', 'custom XHR request working');
		start();
	};
	xhr.send(null);
});

test("encryption", function() {
	var encryption = new TabulatabsEncryption();
	encryption.key = encryption.generateHexKey();
	equal(encryption.decrypt(encryption.encrypt('hello')), 'hello', "Encryption is working");
});

var encryption = new TabulatabsEncryption();
encryption.key = encryption.generateHexKey();

function testBrowser() {
	var browser = new TabulatabsBrowser(encryption);
	browser.useragent = 'Test - JavaScript Test Browser - ' + navigator.userAgent;
	browser.label = 'Unit Testing Fake Browser';
	browser.description = 'If you can see this there is some kind of bug';
	browser.iconURL = 'chrome.png';
	return browser;
}

test("browser", function() {
	stop();

	var browser = testBrowser();

	var password = browser.encryption.generatePassword();
	browser.register(password, function(registration_result) {
		ok(browser.username, 'Registered a username');

		var loadedBrowser = new TabulatabsBrowser(encryption);

		loadedBrowser.username = browser.username;
		loadedBrowser.password = browser.password;

		loadedBrowser.load(function(loading_result) {
			equal(browser.useragent, loadedBrowser.useragent, 'Useragent correctly saved');
			equal(browser.label, loadedBrowser.label, 'Label correctly saved');
			equal(browser.description, loadedBrowser.description, 'Description correctly saved');
			equal(browser.iconURL, loadedBrowser.iconURL, 'iconURL saved correctly');

			start();
		});
	});
});

test('clients / tabs', function() {
	stop();
	
	var browser = testBrowser();

	var password = browser.encryption.generatePassword();
	var claimingClientPassword = browser.encryption.generatePassword();
	var permanentClientPassword = browser.encryption.generatePassword();

	browser.register(password, function(registration_result) {
		var client = new TabulatabsClient(encryption);
		var unclaimedClient = new TabulatabsClient(encryption);

		unclaimedClient.createWithBrowser(browser, claimingClientPassword, function(registration_result) {
			ok(unclaimedClient.username != '', 'Successfully registered a client - will never claim it');

			client.createWithBrowser(browser, claimingClientPassword, function () {
				ok(client.username != '', 'Successfully registered a client - will claim it');
				client.useragent = 'Unit Test Client';
				client.label = 'Fake Unit Test Client';
				client.description = 'If you can see this there was some kind of bug';
				client.iconURL = 'iphone.png';

				client.claim(claimingClientPassword, permanentClientPassword, function(claiming_result) {
					ok(client.password != '', 'Successfully claimed a client');
					ok(client.id != 0, 'returned the id of the just claimed client');

					browser.loadClients(function(loadClientsResult) {
						equal(browser.clients.length, 1, 'returns exactly one registered client');
						
						equal(client.useragent, browser.clients[0].useragent, 'Useragent correctly saved');
						equal(client.label, browser.clients[0].label, 'Label correctly saved');
						equal(client.description, browser.clients[0].description, 'Description correctly saved');
						equal(client.iconURL, browser.clients[0].iconURL, 'iconURL saved correctly');
						equal(client.id, browser.clients[0].id, 'id saved correctly');

						var tab1 = new TabulatabsTab({identifier: 'id1', title: 'title', URL: 'http://tabulatabs.com/', selected: true, favIconURL: 'favicon.ico', windowId: 'wid2', index: 3, pageColors: ['red', 'green', 'blue']});
						var tab2 = new TabulatabsTab({identifier: 'id2', title: 'title2', URL: 'http://tabulatabs.com/2', selected: true, favIconURL: 'favicon2.ico', windowId: 'wid2', index: 4});
						
						var tabs = [tab1, tab2];

						browser.saveTabs(tabs, function(savingTabsResult) {
							equal(savingTabsResult.success, true, 'Tabs saved successfully');

							client.loadTabs(function() {
								equal(client.tabs.length, 2, 'correct number of tabs loaded');

								equal(client.tabs[0].identifier, tab1.identifier, 'save identifier correctly');
								equal(client.tabs[0].title, tab1.title, 'save title correctly');
								equal(client.tabs[0].url, tab1.url, 'save url correctly');
								equal(client.tabs[0].selected, tab1.selected, 'save selected correctly');
								equal(client.tabs[0].favIconURL, tab1.favIconURL, 'save favIconURL correctly');
								equal(client.tabs[0].windowId, tab1.windowId, 'save windowId correctly');
								equal(client.tabs[0].index, tab1.index, 'save index correctly');
								equal(client.tabs[0].pageColors.length, tab1.pageColors.length, 'save pageColors correctly');

								equal(client.tabs[1].identifier, tab2.identifier, 'saved identifier on second tab correctly');

								browser.destroyClient(client, function(destroyClientResult) {
									ok(destroyClientResult.success, 'got invalid response');

									browser.loadClients(function(loadClientsResult) {
										equal(browser.clients.length, 0, 'client was not destroyed');
										start();
									});
								});
							});

						});
					});
				});
			})
		})
	});
});

</script>

	<script type="text/javascript">


// var tabulatabs = new TabulatabsClient('Test');
// 
// var encrypted = tabulatabs.encrypt({message: 'Hello', recipient: 'world'});
// console.dir(encrypted);
// xxx = GibberishAES.Base64.encode(GibberishAES.Base64.decode(encrypted.ic));
// console.dir(GibberishAES.Base64.decode(encrypted.ic));
// console.dir(tabulatabs.decrypt(encrypted));

	</script>

	</body>
</html>
